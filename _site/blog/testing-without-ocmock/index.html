<!DOCTYPE html>
<html lang="en">
   <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-control" content="public">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="keywords" content="hexed bits, apps, iOS, objective-c, swift, cocoa, apple, xcode, app store, software, programming, engineering, design patterns">
    <meta name="description" content="Бесконечность - не предел.">
    <meta name="author" content="Anver Bogatov">

    <title>
        
            Testing and mocking without OCMock &middot; Anver Bogatov
        
    </title>

    <!-- Begin Jekyll SEO tag v2.2.3 -->
<meta property="og:title" content="Testing and mocking without OCMock" />
<meta name="author" content="Anver Bogatov" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="OCMock is a powerful mock object unit testing library for Objective-C. Even if you are using Swift, as long as your classes inherit from NSObject, you can use some of its features. But what if you are writing pure Swift code which does not have access to the dynamic Objective-C runtime? Or, what if you don’t want your Swift code to be hampered by NSObject subclasses and @objc annotations? Perhaps, you merely want to avoid dependencies and use ‘plain old’ XCTest with Objective-C. It’s relatively easy and lightweight to achieve the same effect in some testing scenarios without using OCMock." />
<meta property="og:description" content="OCMock is a powerful mock object unit testing library for Objective-C. Even if you are using Swift, as long as your classes inherit from NSObject, you can use some of its features. But what if you are writing pure Swift code which does not have access to the dynamic Objective-C runtime? Or, what if you don’t want your Swift code to be hampered by NSObject subclasses and @objc annotations? Perhaps, you merely want to avoid dependencies and use ‘plain old’ XCTest with Objective-C. It’s relatively easy and lightweight to achieve the same effect in some testing scenarios without using OCMock." />
<link rel="canonical" href="http://localhost:4000/blog/testing-without-ocmock/" />
<meta property="og:url" content="http://localhost:4000/blog/testing-without-ocmock/" />
<meta property="og:site_name" content="Anver Bogatov" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-01-16T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@anver_bogatov" />
<meta name="twitter:creator" content="@anver_bogatov" />
<script type="application/ld+json">
{"@context":"http://schema.org","@type":"BlogPosting","headline":"Testing and mocking without OCMock","author":{"@type":"Person","name":"Anver Bogatov"},"datePublished":"2017-01-16T00:00:00+00:00","dateModified":"2017-01-16T00:00:00+00:00","description":"OCMock is a powerful mock object unit testing library for Objective-C. Even if you are using Swift, as long as your classes inherit from NSObject, you can use some of its features. But what if you are writing pure Swift code which does not have access to the dynamic Objective-C runtime? Or, what if you don’t want your Swift code to be hampered by NSObject subclasses and @objc annotations? Perhaps, you merely want to avoid dependencies and use ‘plain old’ XCTest with Objective-C. It’s relatively easy and lightweight to achieve the same effect in some testing scenarios without using OCMock.","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/img/logo.png"},"name":"Anver Bogatov"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/testing-without-ocmock/"},"url":"http://localhost:4000/blog/testing-without-ocmock/"}</script>
<!-- End Jekyll SEO tag -->


    <meta name="twitter:image" content="/img/logo.png" />
    <meta property="og:image" content="/img/logo.png" />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="512" />
    <meta property="og:image:height" content="512" />

    <link href="/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="/bower_components/ubuntuMono/ubuntuMono.css" rel="stylesheet">
    <link href="/css/syntax.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="/bower_components/html5shiv/dist/html5shiv.min.js"></script>
      <script src="/bower_components/respond/dest/respond.min.js"></script>
    <![endif]-->

    <link rel="apple-touch-icon" sizes="76x76" href="/ico/icon76.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/ico/icon120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/ico/icon152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/ico/icon167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/ico/icon180.png">

    <link rel="shortcut icon" href="/favicon.ico">
    <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Anver Bogatov" />

    <script>
         (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
         (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
         m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
         ga('create', 'UA-37319916-5', 'auto');
         ga('send', 'pageview');
    </script>
</head>

   <body>
      
<header class="container container-fluid">
   <div class="row">
      <div class="col-md-12 col-sm-12 col-xs-12">
        <h1 class="text-center"><a href="/">Anver Bogatov</a></h1>
        <div class="col-md-12 col-sm-12 col-xs-12">
            <h2 class="tagline">&mdash; Бесконечность - не предел. &mdash;</h2>
         </div> <!-- col -->
      </div> <!-- col -->
   </div> <!-- row -->

   <div class="row menu">
      <div class="col-md-12 col-sm-12 col-xs-12">
         <a class="btn btn-default" href="/">Блог</a>
         <!-- <a class="btn btn-default" href="/speaking/">Speaking</a> -->
         <a class="btn btn-default" href="/about/">Обо мне</a>
      </div> <!-- col -->
   </div> <!-- row -->
   <hr>
</header>


      <div class="container container-fluid">
         <div class="row">
            <div class="col-sm-12 col-sm-offset-0 col-md-10 col-md-offset-1">
               <article>
   <h1 class="post-title"><a href="">Testing and mocking without OCMock</a></h1>
   <h2 class="post-subtitle">For Swift and Objective-C <small class="post-date">16 Jan 2017</small></h2>
   

   <div class="post-content">
      <p><a href="http://ocmock.org">OCMock</a> is a powerful <a href="https://en.wikipedia.org/wiki/Mock_object">mock object</a> unit testing library for Objective-C. Even if you are using Swift, as long as your classes inherit from <code class="highlighter-rouge">NSObject</code>, you can use <a href="http://ocmock.org/swift/">some of its features</a>. But what if you are writing pure Swift code which does not have access to the dynamic Objective-C runtime? Or, what if you don’t want your Swift code to be <a href="/avoiding-objc-in-swift/">hampered</a> by <code class="highlighter-rouge">NSObject</code> subclasses and <code class="highlighter-rouge">@objc</code> annotations? Perhaps, you merely want to avoid dependencies and use ‘plain old’ <code class="highlighter-rouge">XCTest</code> with Objective-C. It’s relatively easy and lightweight to achieve the same effect in some testing scenarios <em>without</em> using <code class="highlighter-rouge">OCMock</code>.</p>

<!--excerpt-->

<h3 id="testable-code">Testable code</h3>

<p>I’m generally not a fan of mocking, and would usually prefer to avoid it altogether. The need for mocking is often (but not always) a warning sign of untestable code. If your code is impossible to test, then it likely suffers from <a href="https://en.wikipedia.org/wiki/Anti-pattern">design deficiencies</a>. I’m not merely talking about the testability of your code for the sake of testing, but rather deeper, architectural design issues — ones that are only revealed once you attempt to write a test. Of course, you could ignore the warnings, but in the coming months (or years!) you will have to reconcile that debt when the system you’ve built requires a change that cannot be accommodated due to its flawed design.</p>

<p>However, writing testable code and mock-free unit tests is not always possible, especially in a <a href="https://www.amazon.com/dp/0131177052">legacy codebase</a>. In this case, you’ll often need to mock the hell out of everything while you refactor towards a more maintainable and malleable system.</p>

<h3 id="avoiding-mocks">Avoiding mocks</h3>

<p>There are a couple of strategies to avoid mocking:</p>

<ol>
  <li>Use actual instances of classes. For example, if you have a <code class="highlighter-rouge">User</code> class, then simply construct a <code class="highlighter-rouge">User</code> in your test instead of mocking. If using Swift, this is exceedingly easy if you make heavy use of value types (<code class="highlighter-rouge">struct</code>, <code class="highlighter-rouge">enum</code>, etc.), which cannot be mocked in the first place. If using a persistence framework like <a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/CoreData/index.html">Core Data</a>, then you can write test helpers to generate fake models, which you can use in your tests. (See also: <a href="https://github.com/jeffh/Fox">Fox</a>)</li>
  <li>Use protocols. If a function or class receives a protocol instead of a concrete type, then your <code class="highlighter-rouge">XCTestCase</code> can conform to that protocol to provide fake inputs. For example, if you have a <code class="highlighter-rouge">UserDataSource</code> protocol that provides and array of <code class="highlighter-rouge">User</code> objects, then your test case can conform to that protocol and generate an array of users to pass into the function or class.</li>
</ol>

<h3 id="common-uses-for-mocking">Common uses for mocking</h3>

<p>The most common — and highly suitable — uses for mocking are for networking events, analytics logging, and user interaction events that utilize the <a href="https://en.wikipedia.org/wiki/Observer_pattern">observer pattern</a>, such as <a href="https://developer.apple.com/library/content/documentation/General/Conceptual/DevPedia-CocoaCore/Delegation.html">delegation in Cocoa</a>. Diving into the details of each of these is beyond the scope of this post. For now, let’s look at an example with delegation.</p>

<h3 id="example-protocols-and-xctestexpectation">Example: protocols and <code class="highlighter-rouge">XCTestExpectation</code></h3>

<p>Suppose we have a view controller that displays a “Yes/No” prompt to the user. After the user selects an option, we need to notify another class of the action taken. This class will perform some operations and then update the UI. We want to test that when an option is tapped that the correct delegate method is called.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">protocol</span> <span class="kt">ControllerProtocol</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">controllerDidSelectYes</span><span class="p">(</span><span class="n">_</span> <span class="nv">controller</span><span class="p">:</span> <span class="kt">Controller</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span>
    <span class="kd">func</span> <span class="nf">controllerDidSelectNo</span><span class="p">(</span><span class="n">_</span> <span class="nv">controller</span><span class="p">:</span> <span class="kt">Controller</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">Controller</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="kt">ControllerProtocol</span><span class="p">?</span>

    <span class="kd">func</span> <span class="nf">didTapYes</span><span class="p">(</span><span class="nv">sender</span><span class="p">:</span> <span class="kt">UIButton</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">controllerDidSelectYes</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">didTapNo</span><span class="p">(</span><span class="nv">sender</span><span class="p">:</span> <span class="kt">UIButton</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">controllerDidSelectNo</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>We could mock <code class="highlighter-rouge">ControllerProtocol</code> with OCMock in an Objective-C test:</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#import &lt;MyApp/MyApp-Swift.h&gt;
</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">test</span> <span class="p">{</span>
    <span class="n">id</span> <span class="n">mockProtocol</span> <span class="o">=</span> <span class="p">[</span><span class="n">OCMockObject</span> <span class="nf">niceMockForProtocol</span><span class="p">:</span><span class="k">@protocol</span><span class="err">(</span><span class="nc">ControllerProtocol</span><span class="p">)];</span>
    <span class="c1">// write test...
</span><span class="p">}</span></code></pre></figure>

<p>But we want to write our tests in Swift, and it would be nice to avoid another dependency. Let’s use <code class="highlighter-rouge">XCTestExpectation</code>. In our test, we can create a class that conforms to <code class="highlighter-rouge">ControllerProtocol</code> and has an <code class="highlighter-rouge">XCTestExpectation</code> property for each protocol method. Each protocol method implementation simply calls <code class="highlighter-rouge">fulfill()</code> on the appropriate expectation.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="kt">FakeDelegate</span><span class="p">:</span> <span class="kt">ControllerProtocol</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">yesExpectation</span><span class="p">:</span> <span class="kt">XCTestExpectation</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">noExpectation</span><span class="p">:</span> <span class="kt">XCTestExpectation</span><span class="p">?</span>

    <span class="kd">func</span> <span class="nf">controllerDidSelectYes</span><span class="p">(</span><span class="n">_</span> <span class="nv">controller</span><span class="p">:</span> <span class="kt">Controller</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">yesExpectation</span><span class="o">!.</span><span class="nf">fulfill</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">controllerDidSelectNo</span><span class="p">(</span><span class="n">_</span> <span class="nv">controller</span><span class="p">:</span> <span class="kt">Controller</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">noExpectation</span><span class="o">!.</span><span class="nf">fulfill</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Now we can use <code class="highlighter-rouge">FakeDelegate</code> in our test:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">func</span> <span class="nf">testDidTapYes</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">controller</span> <span class="o">=</span> <span class="kt">Controller</span><span class="p">()</span>

    <span class="c1">// trigger viewDidLoad:</span>
    <span class="n">controller</span><span class="o">.</span><span class="nf">beginAppearanceTransition</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nv">animated</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>

    <span class="c1">// setup the delegate</span>
    <span class="k">let</span> <span class="nv">delegate</span> <span class="o">=</span> <span class="kt">FakeDelegate</span><span class="p">()</span>
    <span class="n">delegate</span><span class="o">.</span><span class="n">yesExpectation</span> <span class="o">=</span> <span class="nf">expectation</span><span class="p">(</span><span class="nv">description</span><span class="p">:</span> <span class="s">"yes expectation"</span><span class="p">)</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">delegate</span>

    <span class="c1">// helper extension method to "tap" the yes button</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">yesButton</span><span class="o">.</span><span class="nf">simulateTap</span><span class="p">()</span>

    <span class="c1">// wait for our delegate method to be called</span>
    <span class="nf">waitForExpectations</span><span class="p">(</span><span class="nv">timeout</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>If the test fails, that means tapping this button <em>does not</em> notify the delegate.</p>

<p><span class="text-muted"><b>Note:</b> we can write the same test code in pure Objective-C, too.</span></p>

<h3 id="testing-all-the-things">Testing all the things</h3>

<p>This method of testing keeps our tests rather simple and straightforward, and gives us a kind of “mocking” in Swift. The tests are easy to read and edit, and they have no external dependencies. Anyone on your team could easily fix a broken test. The major drawback of this approach is that it introduces some boilerplate, which can be tedious to write if you are writing a lot of tests. However, a benefit here is that we can concretely see how our system works. As mentioned above, writing a test can reveal troublesome designs in our code and in this case we <em>also</em> have to implement our protocol (<code class="highlighter-rouge">ControllerProtocol</code>). If you find that implementing the protocol is difficult — that using it is somehow cumbersome or intertwined with other dependencies — then you should probably reconsider and redesign.</p>

<p>Depending on your uses and the context of your app, the value you gain from this approach to testing may vary. That’s particularly true for the example above — since UI is susceptible to frequent change — but it’s merely an example. If you use this approach for testing your networking, logging, or other aspects of your app that change <em>infrequently</em>, then it should carry its weight better. I especially find this valuable for testing self-contained libraries and frameworks. When a library has no dependencies, it’s nice to avoid testing dependencies as well.</p>

<p>Finally, I want to make it clear that <code class="highlighter-rouge">OCMock</code> is a <strong>great</strong> tool. <strong>You should use it</strong> when it makes sense: when you need its advanced features, when working with legacy code, etc. But if your use cases are simple, then <code class="highlighter-rouge">XCTestExpectation</code> can get the job done. And if you want to stay in the Swift world, then you don’t have a choice. :)</p>

   </div> <!-- post-content -->
</article>


<div class="post-share-subscribe">
   <div class="row">
      <div class="col-md-6 col-sm-6 col-xs-12 center">
         <div class="btn-group btn-group-justified" role="group">

            <div class="btn-group dropup" role="group">
               <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Share &nbsp;<i class="fa fa-share-alt" aria-hidden="true"></i>
               </button>
               <ul class="dropdown-menu">
                  <li>
                     <a href="https://twitter.com/intent/tweet?text=Testing%20and%20mocking%20without%20OCMock%20http://localhost:4000/blog/testing-without-ocmock/%20via%20@anver_bogatov" title="Tweet" target="_blank">
                     Twitter &nbsp;<i class="fa fa-twitter" aria-hidden="true"></i>
                     </a>
                  </li>
                  <li>
                     <a href="https://www.facebook.com/sharer.php?u=http://localhost:4000/blog/testing-without-ocmock/" title="Post" target="_blank">
                     Facebook &nbsp;<i class="fa fa-facebook" aria-hidden="true"></i>
                     </a>
                  </li>
                  <li>
                     <a href="https://plus.google.com/share?url=http://localhost:4000/blog/testing-without-ocmock/" title="Share" target="_blank">
                     Google &nbsp;<i class="fa fa-google-plus" aria-hidden="true"></i>
                     </a>
                  </li>
               </ul>
            </div> <!-- share dropup -->

            <div class="btn-group dropup" role="group">
               <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Subscribe &nbsp;<i class="fa fa-rss" aria-hidden="true"></i>
               </button>
               <ul class="dropdown-menu">
                  <li><a href="/feed.xml" title="Subscribe via RSS/atom">RSS/Atom &nbsp;<i class="fa fa-rss" aria-hidden="true"></i></a></li>
                  <li><a href="" title="Add to Apple News">Apple News &nbsp;<i class="fa fa-apple" aria-hidden="true"></i></a></li>
               </ul>
            </div> <!-- subscribe drop-up -->

            <div class="btn-group dropup" role="group">
               <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Support &nbsp;<i class="fa fa-star" aria-hidden="true"></i>
               </button>
               <ul class="dropdown-menu">
                  <li><a href="" title="Donate via PayPal" target="_blank">Donate via PayPal &nbsp;<i class="fa fa-paypal" aria-hidden="true"></i></a></li>
                  <li><a href="" title="Donate via Square Cash" target="_blank">Donate via Square &nbsp;<i class="fa fa-dollar" aria-hidden="true"></i></a></li>
                  <li><a href="" title="Donate Bitcoin" target="_blank">Donate Bitcoin &nbsp;<i class="fa fa-btc" aria-hidden="true"></i></a></li>
               </ul>
            </div> <!-- donate drop-up -->

         </div> <!-- btn-group -->
      </div> <!-- col -->
   </div> <!-- row -->

   <div class="row feedback">
      <div class="col-md-6 col-sm-6 col-xs-12 center">
         <p class="text-muted text-center"><small><b>Questions? Feedback? Corrections?</b></small></p>
         <p class="text-muted text-center"><small>
         Open an <a href="https://github.com/anverbogatov/anverbogatov.github.io/issues/new" target="_blank">issue</a> or
         submit a <a href="https://github.com/anverbogatov/anverbogatov.github.io/compare" target="_blank">pull request</a>.
         </small></p>
      </div> <!-- col -->
   </div> <!-- row -->

</div> <!-- post-share-subscribe -->


            </div> <!-- col -->
         </div> <!-- row -->
      </div> <!-- container -->

      
<footer class="container container-fluid">
   <hr>

   <div class="row contact">
    <div class="col-sm-12 col-sm-offset-0 col-md-8 col-md-offset-2">
        <ul class="inline center">
            <li><a href="https://github.com/anverbogatov" title="Ищи меня на Github"><i class="fa fa-2x fa-github" aria-hidden="true"></i></a></li>
            <li><a href="https://twitter.com/anver_bogatov" title="Ищи меня в Twitter"><i class="fa fa-2x fa-twitter" aria-hidden="true"></i></a></li>
            <li><a href="https://www.linkedin.com/in/anver-bogatov-64b32661/" title="Свяжись со мной в LinkedIn"><i class="fa fa-2x fa-linkedin" aria-hidden="true"></i></a></li>
            <li><a href="/feed.xml" title="Подпишись с помощью RSS/atom"><i class="fa fa-2x fa-rss-square" aria-hidden="true"></i></a></li>
        </ul>
    </div> <!-- col -->
</div> <!-- row -->


   <p class="text-muted text-center"><small>
   &copy; 2017 Anver Bogatov.
   Это сайт с <a href="https://github.com/anverbogatov/anverbogatov.github.io">открытым исходным кодом</a>.
   </small></p>
</footer>

      
<script src="/bower_components/jquery/dist/jquery.min.js"></script>
<script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

   </body>
</html>
